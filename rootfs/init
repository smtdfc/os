#!/bin/sh

mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts

[ -c /dev/console ] || mknod -m 600 /dev/console c 5 1
[ -c /dev/null ] || mknod -m 666 /dev/null c 1 3
[ -c /dev/tty ] || mknod -m 666 /dev/tty c 5 0
[ -c /dev/tty0 ] || mknod -m 666 /dev/tty0 c 4 0
[ -c /dev/ttyS0 ] || mknod -m 600 /dev/ttyS0 c 4 64
[ -c /dev/ptmx ] || mknod -m 666 /dev/ptmx c 5 2

exec >/dev/ttyS0 2>&1 </dev/ttyS0

export TIGER_REGISTRY_HOST="https://tiger-registry.onrender.com"

ip addr add 10.0.2.15/24 dev eth0
ip link set eth0 up
ip route add default via 10.0.2.2
echo "nameserver 8.8.8.8" > /etc/resolv.conf

dmesg -n 1

echo "                _      _  __                  "
echo "  ___ _ __ ___ | |_ __| |/ _| ___    ___  ___ "
echo " / __| '_ \` _ \| __/ _\` | |_ / __|  / _ \/ __|"
echo " \__ \ | | | | | || (_| |  _| (__  | (_) \__ \\"
echo " |___/_| |_| |_|\__\__,_|_|  \___|  \___/|___/"
echo "                                              "

echo -e "\033[1;32mWelcome to smtdfcOS (GNU/Linux 6.16.0-smtdfcOS x86_64)\033[0m"
echo
echo -e " * Author:         \033[1;34mhttps://smtdfc.is-a.dev\033[0m"
echo -e " * Report issues:  \033[1;34mhttps://github.com/smtdfc/os/issues\033[0m"
echo -e " * Donate:         \033[1;34mhttps://ko-fi.com/smtdfc\033[0m"
echo
echo "  Last login: $(date) from $(ip route get 1 | awk '{print $NF; exit}')"

# Mount and switch root
if [ -b /dev/vda ]; then
  echo "[+] Found /dev/vda, preparing persistent rootfs..."

  mkdir -p /mnt/root

  # Format disk
  if ! blkid /dev/vda | grep -q ext4; then
    echo "[*] Formatting /dev/vda as ext4..."
    mkfs.ext4 -F /dev/vda
  fi

  mount /dev/vda /mnt/root

  if [ ! -f /mnt/root/.initialized ]; then
    echo "[*] Copying rootfs to /dev/vda..."
    cp -a /bin /sbin /etc /lib /lib64 /usr /dev /proc /sys /mnt/root
    touch /mnt/root/.initialized
    echo "[✓] Rootfs installed on /dev/vda"
  fi

  umount /mnt/root/dev || true
  umount /mnt/root/proc || true
  umount /mnt/root/sys || true

  echo "[✓] Switching to real root..."
  exec switch_root /mnt/root /sbin/init
fi

echo "[!] No persistent disk found. Booting into RAM only (initramfs mode)."
exec setsid cttyhack sh
